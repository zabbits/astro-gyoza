---
import type { GetStaticPaths } from 'astro'
import type { CollectionEntry } from 'astro:content'
import { getCollection, render } from 'astro:content'
import MarkdownLayout from '@/layouts/MarkdownLayout.astro'
import PageLayout from '@/layouts/PageLayout.astro'
import Highlight from '@/components/Highlight.astro'
import MarkdownWrapper from '@/components/MarkdownWrapper.astro'
import FriendList from '@/components/FriendList.astro'
import ProjectList from '@/components/ProjectList.astro'
import { ReadingProgress } from '@/components/post/ReadingProgress'
import { PostToc } from '@/components/post/PostToc'
import { Comments } from '@/components/comment'

export const getStaticPaths = (async () => {
  const specList = await getCollection('spec')

  return specList.map((md) => ({
    params: { spec: md.id },
    props: {
      md,
    },
  }))
}) satisfies GetStaticPaths

interface Props {
  md: CollectionEntry<'spec'>
}

const { md } = Astro.props

const { headings, Content } = await render(md)

const isPageLayout = ['friends', 'projects', 'about'].includes(md.id)
const isMdContentEmpty = md.body?.trim().length === 0
---

{
  isPageLayout ? (
    <PageLayout title={md.data.title} description={md.data.description}>
      <div class="max-w-[900px] mx-auto px-4 py-16 md:px-4">
        <div class="md:mx-[64px] md:px-4 space-y-8" data-pagefind-body>
          <header class="space-y-4">
            <h1 class="text-3xl font-bold">
              <Highlight>{md.data.title}</Highlight>
            </h1>
            <p>{md.data.description}</p>
          </header>
          {md.id === 'friends' && <FriendList />}
          {md.id === 'projects' && <ProjectList />}
          {!isMdContentEmpty && (
            <MarkdownWrapper>
              <Content />
            </MarkdownWrapper>
          )}
          {md.data.comments && <Comments />}
        </div>
      </div>
    </PageLayout>
  ) : (
    <MarkdownLayout
      title={md.data.title}
      description={md.data.description}
      mdTitle={md.data.title}
      mdDescription={md.data.description}
      mdSlug={md.id}
    >
      <div class="py-16" data-pagefind-body>
        <div class="relative mx-auto w-full max-w-[900px] px-4 md:px-4">
          <div class="md:min-w-0 md:mx-[64px] md:px-4">
            <header class="space-y-4">
              <h1 class="text-3xl font-bold">
                <Highlight>{md.data.title}</Highlight>
              </h1>
              <p>{md.data.description}</p>
            </header>

            <div class="mt-8">
              <MarkdownWrapper>
                <Content />
              </MarkdownWrapper>
            </div>

            {md.data.comments && <Comments />}
          </div>
        </div>

        <aside
          class="hidden lg:block fixed top-36 w-[160px]"
          style="left: calc((100vw - 900px) / 2 + 900px - 64px)"
          data-pagefind-ignore
        >
          <div class="space-y-4">
            <PostToc headings={headings} client:idle />
            <hr class="my-2 border-primary max-w-[100px]" />
            <ReadingProgress client:idle />
          </div>
        </aside>
      </div>
    </MarkdownLayout>
  )
}
